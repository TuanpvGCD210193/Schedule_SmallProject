<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniSchedule | Nh·∫Øc Nh·ªü U·ªëng N∆∞·ªõc</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #ff6b9d;
            --secondary-pink: #ffc2d4;
            --light-pink: #ffe5ec;
            --accent-orange: #ffab73;
            --accent-blue: #007aff;
            --accent-purple: #8e44ad;
            --white: #ffffff;
            --text-dark: #4a4a4a;
            --text-medium: #666;
            --text-light: #888;
            --shadow-soft: 0 8px 32px rgba(255, 107, 157, 0.15);
            --shadow-hover: 0 12px 48px rgba(255, 107, 157, 0.25);
        }

        body {
            font-family: 'Quicksand', 'Inter', sans-serif;
            background: linear-gradient(135deg, #ffeef2 0%, #fff0f6 50%, #ffe5ec 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Pattern */
        .net-pattern {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0.03;
            background-image: 
                repeating-linear-gradient(0deg, var(--primary-pink), var(--primary-pink) 2px, transparent 2px, transparent 20px),
                repeating-linear-gradient(90deg, var(--primary-pink), var(--primary-pink) 2px, transparent 2px, transparent 20px);
            pointer-events: none;
            z-index: 0;
        }

        /* Main Container */
        .water-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        .water-box {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 40px;
            padding: 50px 40px;
            box-shadow: var(--shadow-soft);
            border: 3px solid rgba(255, 107, 157, 0.1);
            position: relative;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* User Profile */
        .user-profile {
            text-align: center;
            margin-bottom: 30px;
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--primary-pink);
            box-shadow: 0 8px 24px rgba(255, 107, 157, 0.3);
            margin-bottom: 15px;
            animation: pulse-avatar 3s infinite ease-in-out;
        }

        @keyframes pulse-avatar {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .user-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-pink);
        }

        /* Title */
        .water-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-pink);
            text-align: center;
            margin-bottom: 40px;
        }

        /* Streak Container */
        .streak-section {
            background: linear-gradient(135deg, #ff6b9d 0%, #ffd700 50%, #ff4757 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            color: white;
        }

        .streak-number {
            font-size: 4rem;
            font-weight: 900;
            margin: 10px 0;
        }

        .streak-level {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Progress Section */
        .progress-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 30px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 30px;
            text-align: center;
        }

        .progress-title {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary-pink);
            margin-bottom: 20px;
        }

        .progress-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-pink);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-dark);
            font-weight: 600;
        }

        /* Water Glass */
        .water-glass {
            width: 200px;
            height: 250px;
            margin: 30px auto;
            position: relative;
            background: transparent;
            border: 8px solid var(--primary-pink);
            border-radius: 20px 20px 60px 60px;
            overflow: hidden;
        }

        .water-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--primary-pink), var(--secondary-pink));
            height: 0%;
            transition: height 0.5s ease;
            border-radius: 0 0 50px 50px;
        }

        /* Drink Button */
        .drink-button {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-purple) 50%, var(--accent-orange) 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 30px;
            font-size: 1.3rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 30px auto 0;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .drink-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 107, 157, 0.5);
        }

        .drink-button:active {
            transform: translateY(-1px) scale(1.02);
        }

        .drink-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Back Button */
        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--white);
            border: 3px solid var(--primary-pink);
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-pink);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
            z-index: 100;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .back-button:hover {
            background: var(--primary-pink);
            color: var(--white);
            transform: translateX(-5px);
        }

        /* Notification Bell */
        .notification-bell {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-purple) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
            z-index: 100;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            font-size: 1.5rem;
        }

        .notification-bell:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-hover);
        }

        .notification-bell.has-notifications {
            animation: bellShake 1s infinite ease-in-out;
        }

        @keyframes bellShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            background: #ff4757;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            animation: badgePulse 2s infinite ease-in-out;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 350px;
            max-height: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: var(--shadow-hover);
            border: 3px solid rgba(255, 107, 157, 0.1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .notification-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .notification-header {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--accent-purple) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .notification-title {
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .notification-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .notification-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .notification-item {
            background: var(--white);
            border: 2px solid var(--light-pink);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.2);
            border-color: var(--primary-pink);
        }

        .notification-item.unread {
            background: linear-gradient(135deg, var(--light-pink) 0%, rgba(255, 107, 157, 0.05) 100%);
            border-color: var(--primary-pink);
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-pink);
            border-radius: 15px 0 0 15px;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 0.9rem;
            color: var(--text-dark);
            font-weight: 600;
            line-height: 1.4;
        }

        /* Reminder Schedule */
        .reminder-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 30px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 30px;
        }

        .reminder-title {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary-pink);
            margin-bottom: 20px;
            text-align: center;
        }

        .reminder-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .reminder-item {
            background: var(--white);
            border: 2px solid var(--light-pink);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .reminder-item.completed {
            background: linear-gradient(135deg, var(--light-pink) 0%, rgba(255, 107, 157, 0.1) 100%);
            border-color: var(--primary-pink);
        }

        .reminder-item.current {
            background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-pink) 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
            animation: currentPulse 2s infinite ease-in-out;
        }

        @keyframes currentPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 107, 157, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 107, 157, 0.6);
            }
        }

        .reminder-item.missed {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            border-color: #ff3742;
        }

        .reminder-time {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .reminder-status {
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary-pink);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .spinner {
            border: 4px solid var(--light-pink);
            border-top: 4px solid var(--primary-pink);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error State */
        .error-message {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: 700;
        }

        /* Success Message */
        .success-message {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: 700;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .water-box {
                padding: 40px 25px;
                border-radius: 30px;
            }

            .water-title {
                font-size: 1.6rem;
            }

            .streak-number {
                font-size: 3rem;
            }

            .water-glass {
                width: 150px;
                height: 200px;
            }

            .back-button {
                top: 20px;
                left: 20px;
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .notification-bell {
                top: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .notification-panel {
                right: 15px;
                width: calc(100vw - 30px);
                max-width: 350px;
            }
            
            .reminder-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Background Pattern -->
    <div class="net-pattern"></div>

    <!-- Back Button -->
    <button class="back-button" id="backButton">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
        <span>Quay l·∫°i</span>
    </button>

    <!-- Notification Bell -->
    <div class="notification-bell" id="notificationBell">
        üîî
        <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <button class="notification-close" id="notificationClose">√ó</button>
            <div class="notification-title">üîî Th√¥ng B√°o</div>
            <div class="notification-subtitle">Nh·∫Øc nh·ªü u·ªëng n∆∞·ªõc</div>
        </div>
        <div class="notification-list" id="notificationList">
            <div style="text-align: center; padding: 20px; color: var(--text-light);">
                Ch∆∞a c√≥ th√¥ng b√°o n√†o
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="water-container">
        <div class="water-box">
            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <div>ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>

            <!-- Error State -->
            <div id="errorState" style="display: none;">
                <div class="error-message" id="errorMessage"></div>
                <button class="drink-button" onclick="location.reload()">
                    üîÑ T·∫£i l·∫°i
                </button>
            </div>

            <!-- Main Content -->
            <div id="mainContent" style="display: none;">
                <!-- User Profile -->
                <div class="user-profile">
                    <img src="assets/quynh-avatar.jpg" alt="Avatar" class="user-avatar" 
                         onerror="this.src='https://ui-avatars.com/api/?name=Quynh&background=ff6b9d&color=fff&size=200'">
                    <div class="user-name">_uyqhn üíß</div>
                </div>

                <h1 class="water-title">üíß Nh·∫Øc Nh·ªü U·ªëng N∆∞·ªõc</h1>

                <!-- Streak Section -->
                <div class="streak-section">
                    <div class="streak-title">üî• Chu·ªói U·ªëng N∆∞·ªõc</div>
                    <div class="streak-number" id="streakNumber">0</div>
                    <div class="streak-level" id="streakLevel">B·∫Øt ƒë·∫ßu</div>
                    <div style="font-size: 3rem; margin-top: 15px;" id="streakEmoji">üíß</div>
                </div>

                <!-- Progress Section -->
                <div class="progress-section">
                    <div class="progress-title">üìä Ti·∫øn ƒê·ªô H√¥m Nay</div>
                    
                    <!-- Progress Stats -->
                    <div class="progress-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="completedGlasses">0</div>
                            <div class="stat-label">ƒê√£ u·ªëng</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalGlasses">8</div>
                            <div class="stat-label">M·ª•c ti√™u</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="remainingGlasses">8</div>
                            <div class="stat-label">C√≤n l·∫°i</div>
                        </div>
                    </div>

                    <!-- Water Glass -->
                    <div class="water-glass">
                        <div class="water-level" id="waterLevel"></div>
                    </div>
                </div>

                <!-- Reminder Schedule -->
                <div class="reminder-section">
                    <div class="reminder-title">‚è∞ L·ªãch Nh·∫Øc Nh·ªü</div>
                    <div class="reminder-list" id="reminderList">
                        <!-- Reminder items will be generated here -->
                    </div>
                </div>

                <!-- Success Message -->
                <div id="successMessage" style="display: none;" class="success-message"></div>

                <!-- Drink Button -->
                <button class="drink-button" id="drinkButton">
                    üíß ƒê√£ U·ªëng N∆∞·ªõc!
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // ============================================================================
        // üéØ WATER TRACKING APP - CLEAN ARCHITECTURE
        // ============================================================================

        // Get user from URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || 'quynh';
        const FIREBASE_URL = `https://unisched-app-11368-default-rtdb.asia-southeast1.firebasedatabase.app/users/${currentUser}/water_tracking.json`;

        // ============================================================================
        // üì¶ STATE MANAGEMENT
        // ============================================================================

        const State = {
            // Core data
            streak: 0,
            glasses: 0,
            totalGlasses: 8,
            lastDrinkTime: 0,
            lastStreakDate: new Date().toDateString(),
            windowStreaks: {},
            
            // Notifications
            notifications: [],
            
            // Reminder times
            reminderTimes: [
                { time: '06:00', label: '6:00 S√°ng' },
                { time: '08:00', label: '8:00 S√°ng' },
                { time: '10:00', label: '10:00 S√°ng' },
                { time: '12:00', label: '12:00 Tr∆∞a' },
                { time: '14:00', label: '2:00 Chi·ªÅu' },
                { time: '16:00', label: '4:00 Chi·ªÅu' },
                { time: '18:00', label: '6:00 T·ªëi' },
                { time: '20:00', label: '8:00 T·ªëi' }
            ],
            
            // Reminder status
            reminderStatus: {},
            
            // UI state
            loading: true,
            error: null,
            saving: false,
            
            // Config
            cooldown: 3000, // 3 seconds between clicks
            
            // Get computed values
            get remaining() {
                return this.totalGlasses - this.glasses;
            },
            
            get progress() {
                return (this.glasses / this.totalGlasses) * 100;
            },
            
            get unreadCount() {
                return this.notifications.filter(n => !n.read).length;
            },
            
            get canDrink() {
                const now = Date.now();
                const hour = new Date().getHours();
                
                // Time validation: 6 AM - 10 PM
                if (hour < 6 || hour >= 22) return false;
                
                // Cooldown check
                if (now - this.lastDrinkTime < this.cooldown) return false;
                
                // Goal check
                if (this.glasses >= this.totalGlasses) return false;
                
                return true;
            }
        };

        // ============================================================================
        // üíæ DATA LAYER - Firebase Operations
        // ============================================================================

        const DataLayer = {
            // Load data from Firebase
            async load() {
                try {
                    console.log('üì• Loading from Firebase...');
                    const response = await fetch(FIREBASE_URL);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data) {
                        State.streak = data.current_streak || 0;
                        State.glasses = data.completed_glasses || 0;
                        State.totalGlasses = data.total_glasses || 8;
                        State.lastStreakDate = data.last_streak_date || new Date().toDateString();
                        State.windowStreaks = data.window_streaks || {};
                        State.reminderStatus = data.reminder_status || {};
                        
                        console.log('‚úÖ Loaded - Streak:', State.streak, '| Glasses:', State.glasses);
                        return true;
                    }
                    
                    console.log('üìù No data found - using defaults');
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Load error:', error);
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Firebase');
                }
            },
            
            // Save data to Firebase
            async save() {
                if (State.saving) {
                    console.log('‚è≥ Save already in progress');
                    return;
                }
                
                State.saving = true;
                
                try {
                    console.log('üíæ Saving to Firebase...');
                    
                    const data = {
                        current_streak: State.streak,
                        completed_glasses: State.glasses,
                        total_glasses: State.totalGlasses,
                        last_streak_date: State.lastStreakDate,
                        window_streaks: State.windowStreaks,
                        reminder_status: State.reminderStatus,
                        last_updated: new Date().toISOString(),
                        save_timestamp: Date.now()
                    };
                    
                    const response = await fetch(FIREBASE_URL, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    console.log('‚úÖ Saved - Streak:', State.streak, '| Glasses:', State.glasses);
                    State.saving = false;
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Save error:', error);
                    State.saving = false;
                    throw new Error('Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu l√™n Firebase');
                }
            },
            
            // Debounced save (wait 1 second before saving)
            saveDebounced: (() => {
                let timeout;
                return () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        DataLayer.save().catch(err => {
                            console.error('Background save failed:', err);
                        });
                    }, 1000);
                };
            })()
        };

        // ============================================================================
        // üé® UI LAYER - DOM Updates
        // ============================================================================

        const UI = {
            // Get element safely
            get(id) {
                return document.getElementById(id);
            },
            
            // Show/hide elements
            show(id) {
                const el = this.get(id);
                if (el) el.style.display = '';
            },
            
            hide(id) {
                const el = this.get(id);
                if (el) el.style.display = 'none';
            },
            
            // Set text content safely
            setText(id, text) {
                const el = this.get(id);
                if (el) el.textContent = text;
            },
            
            // Update streak display
            updateStreak() {
                this.setText('streakNumber', State.streak);
                
                const levelInfo = this.getStreakLevel(State.streak);
                this.setText('streakLevel', levelInfo.name);
                this.setText('streakEmoji', levelInfo.emoji);
            },
            
            // Update progress display
            updateProgress() {
                this.setText('completedGlasses', State.glasses);
                this.setText('totalGlasses', State.totalGlasses);
                this.setText('remainingGlasses', State.remaining);
                
                const waterLevel = this.get('waterLevel');
                if (waterLevel) {
                    waterLevel.style.height = State.progress + '%';
                }
            },
            
            // Update button state
            updateButton() {
                const button = this.get('drinkButton');
                if (button) {
                    button.disabled = !State.canDrink;
                }
            },
            
            // Update notification badge
            updateNotificationBadge() {
                const badge = this.get('notificationBadge');
                const bell = this.get('notificationBell');
                
                if (badge && bell) {
                    if (State.unreadCount > 0) {
                        badge.textContent = State.unreadCount;
                        badge.style.display = 'flex';
                        bell.classList.add('has-notifications');
                    } else {
                        badge.style.display = 'none';
                        bell.classList.remove('has-notifications');
                    }
                }
            },
            
            // Update notification list
            updateNotificationList() {
                const list = this.get('notificationList');
                if (!list) return;
                
                if (State.notifications.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light);">Ch∆∞a c√≥ th√¥ng b√°o n√†o</div>';
                    return;
                }
                
                list.innerHTML = State.notifications.map(notif => `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="Notifications.markAsRead(${notif.id})">
                        <div class="notification-time">${new Date(notif.timestamp).toLocaleTimeString('vi-VN')}</div>
                        <div class="notification-message">${notif.message}</div>
                    </div>
                `).join('');
            },
            
            // Toggle notification panel
            toggleNotificationPanel() {
                const panel = this.get('notificationPanel');
                if (panel) {
                    panel.classList.toggle('show');
                }
            },
            
            // Update reminder schedule
            updateReminderSchedule() {
                const list = this.get('reminderList');
                if (!list) return;
                
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                list.innerHTML = State.reminderTimes.map(reminder => {
                    const [hour, minute] = reminder.time.split(':').map(Number);
                    const reminderKey = reminder.time;
                    const status = State.reminderStatus[reminderKey] || { completed: false, missed: false };
                    
                    let className = '';
                    let statusText = '‚è≥ Ch·ªù';
                    
                    if (status.completed) {
                        className = 'completed';
                        statusText = '‚úÖ ƒê√£ u·ªëng';
                    } else if (status.missed) {
                        className = 'missed';
                        statusText = '‚ùå B·ªè l·ª°';
                    } else if (currentHour === hour) {
                        className = 'current';
                        statusText = '‚è∞ ƒêang nh·∫Øc';
                    } else if (currentHour > hour || (currentHour === hour && currentMinute > minute)) {
                        className = 'missed';
                        statusText = '‚ùå B·ªè l·ª°';
                    }
                    
                    return `
                        <div class="reminder-item ${className}">
                            <div class="reminder-time">${reminder.label}</div>
                            <div class="reminder-status">${statusText}</div>
                        </div>
                    `;
                }).join('');
            },
            
            // Show success message
            showSuccess(message) {
                const el = this.get('successMessage');
                if (el) {
                    el.textContent = message;
                    el.style.display = '';
                    
                    setTimeout(() => {
                        el.style.display = 'none';
                    }, 3000);
                }
            },
            
            // Show error
            showError(message) {
                State.error = message;
                const el = this.get('errorMessage');
                if (el) el.textContent = message;
                this.show('errorState');
                this.hide('mainContent');
                this.hide('loadingState');
            },
            
            // Show loading
            showLoading() {
                this.show('loadingState');
                this.hide('mainContent');
                this.hide('errorState');
            },
            
            // Show main content
            showMain() {
                this.hide('loadingState');
                this.hide('errorState');
                this.show('mainContent');
            },
            
            // Update all UI
            updateAll() {
                this.updateStreak();
                this.updateProgress();
                this.updateButton();
                this.updateNotificationBadge();
                this.updateReminderSchedule();
            },
            
            // Get streak level info
            getStreakLevel(streak) {
                const levels = [
                    { min: 0, max: 2, name: "B·∫Øt ƒë·∫ßu", emoji: "üíß" },
                    { min: 3, max: 6, name: "Kh·ªüi ƒë·ªông", emoji: "üí¶" },
                    { min: 7, max: 13, name: "Tu·∫ßn ƒë·∫ßu", emoji: "üåä" },
                    { min: 14, max: 29, name: "Ki√™n tr√¨", emoji: "üèä‚Äç‚ôÄÔ∏è" },
                    { min: 30, max: 59, name: "Th√°ng v√†ng", emoji: "üèÜ" },
                    { min: 60, max: 99, name: "Si√™u c∆∞·ªùng", emoji: "‚ö°" },
                    { min: 100, max: 364, name: "Huy·ªÅn tho·∫°i", emoji: "üëë" },
                    { min: 365, max: Infinity, name: "B·∫•t t·ª≠", emoji: "üåü" }
                ];
                
                return levels.find(level => streak >= level.min && streak <= level.max) || levels[0];
            }
        };

        // ============================================================================
        // üîî NOTIFICATION SYSTEM
        // ============================================================================

        const Notifications = {
            // Create notification
            create(message) {
                const notification = {
                    id: Date.now(),
                    message: message,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                State.notifications.unshift(notification);
                
                // Keep only last 20 notifications
                if (State.notifications.length > 20) {
                    State.notifications = State.notifications.slice(0, 20);
                }
                
                UI.updateNotificationList();
                UI.updateNotificationBadge();
                
                console.log('üîî Notification created:', message);
            },
            
            // Mark as read
            markAsRead(notificationId) {
                const notif = State.notifications.find(n => n.id === notificationId);
                if (notif) {
                    notif.read = true;
                    UI.updateNotificationList();
                    UI.updateNotificationBadge();
                }
            },
            
            // Check for reminder notifications
            checkReminders() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTimeString = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
                
                const isReminderTime = State.reminderTimes.some(r => r.time === currentTimeString);
                
                if (isReminderTime && State.glasses < State.totalGlasses) {
                    this.create('‚è∞ ƒê√£ ƒë·∫øn gi·ªù u·ªëng n∆∞·ªõc! H√£y u·ªëng m·ªôt ly n∆∞·ªõc ƒë·ªÉ duy tr√¨ streak.');
                }
                
                // Update reminder schedule
                UI.updateReminderSchedule();
            },
            
            // Setup reminder check interval
            setup() {
                // Check every minute
                setInterval(() => {
                    this.checkReminders();
                }, 60000);
                
                // Initial check
                this.checkReminders();
            }
        };

        // ============================================================================
        // üß† BUSINESS LOGIC
        // ============================================================================

        const Logic = {
            // Process drinking water
            async drinkWater() {
                if (!State.canDrink) {
                    console.warn('Cannot drink right now');
                    UI.showSuccess('‚ö†Ô∏è Ch·ªù m·ªôt ch√∫t n·ªØa nh√©!');
                    return;
                }
                
                const now = Date.now();
                const currentTime = new Date();
                const currentHour = currentTime.getHours();
                
                // Update state
                State.glasses++;
                State.lastDrinkTime = now;
                
                // Mark current reminder as completed
                const timeKey = `${currentHour.toString().padStart(2, '0')}:00`;
                State.reminderStatus[timeKey] = { completed: true, missed: false };
                
                // Check if new day
                const today = currentTime.toDateString();
                if (State.lastStreakDate !== today) {
                    State.windowStreaks = {};
                    State.lastStreakDate = today;
                }
                
                // Calculate streak (simplified logic)
                const windowKey = `${Math.floor(currentHour / 2)}h`;
                if (!State.windowStreaks[windowKey]) {
                    State.windowStreaks[windowKey] = { count: 0, streakEarned: false };
                }
                
                State.windowStreaks[windowKey].count++;
                
                // Award streak for first drink in 2-hour window
                if (!State.windowStreaks[windowKey].streakEarned) {
                    State.streak++;
                    State.windowStreaks[windowKey].streakEarned = true;
                    UI.showSuccess(`‚úÖ +1 Streak! Hi·ªán t·∫°i: ${State.streak} üî•`);
                    Notifications.create(`üî• Tuy·ªát v·ªùi! B·∫°n ƒë√£ ƒë·∫°t ${State.streak} streak!`);
                } else {
                    UI.showSuccess(`‚úÖ +1 ly n∆∞·ªõc! T·ªïng: ${State.glasses}/${State.totalGlasses} üíß`);
                }
                
                // Update UI optimistically
                UI.updateAll();
                
                // Save to Firebase in background
                try {
                    await DataLayer.save();
                } catch (error) {
                    console.error('Save failed:', error);
                    UI.showSuccess('‚ö†Ô∏è ƒê√£ u·ªëng nh∆∞ng ch∆∞a l∆∞u ƒë∆∞·ª£c. Th·ª≠ l·∫°i sau.');
                }
            }
        };

        // ============================================================================
        // üöÄ APP INITIALIZATION
        // ============================================================================

        async function init() {
            console.log('üöÄ Initializing Water Tracking App...');
            
            try {
                // Show loading
                UI.showLoading();
                
                // Load data from Firebase
                await DataLayer.load();
                
                // Update UI
                UI.updateAll();
                
                // Setup notification system
                Notifications.setup();
                
                // Show main content
                UI.showMain();
                
                console.log('‚úÖ Initialization complete');
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                UI.showError(error.message || 'L·ªói khi kh·ªüi t·∫°o ·ª©ng d·ª•ng');
            }
        }

        // ============================================================================
        // üì± EVENT LISTENERS
        // ============================================================================

        // Drink button
        const drinkButton = UI.get('drinkButton');
        if (drinkButton) {
            drinkButton.addEventListener('click', () => {
                Logic.drinkWater();
            });
        }

        // Back button
        const backButton = UI.get('backButton');
        if (backButton) {
            backButton.addEventListener('click', () => {
                window.location.href = `quynh-functions.html?user=${currentUser}`;
            });
        }

        // Notification bell
        const notificationBell = UI.get('notificationBell');
        if (notificationBell) {
            notificationBell.addEventListener('click', () => {
                UI.toggleNotificationPanel();
            });
        }

        // Notification close button
        const notificationClose = UI.get('notificationClose');
        if (notificationClose) {
            notificationClose.addEventListener('click', () => {
                UI.toggleNotificationPanel();
            });
        }

        // Close panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = UI.get('notificationPanel');
            const bell = UI.get('notificationBell');
            
            if (panel && bell && !panel.contains(e.target) && !bell.contains(e.target)) {
                panel.classList.remove('show');
            }
        });

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Make functions globally available for debugging
        window.State = State;
        window.DataLayer = DataLayer;
        window.UI = UI;
        window.Logic = Logic;
        window.Notifications = Notifications;
        
    </script>
</body>
</html>

