<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>L·ªãch | UniSchedule</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-quynh: #c2185b;
            --primary-light: #e91e63;
            --bg-light: #fff5f8;
            --text-dark: #333;
            --text-medium: #555;
            --text-light: #888;
            --border-light: #ffd4e5;
            --shadow-sm: 0 2px 8px rgba(194, 24, 91, 0.08);
            --shadow-md: 0 4px 20px rgba(194, 24, 91, 0.12);
            --shadow-lg: 0 8px 32px rgba(194, 24, 91, 0.2);
            --hour-height: 80px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fff5f8 0%, #ffe5ec 50%, #ffd4e5 100%);
            color: var(--text-dark);
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        .hidden { display: none !important; }

        /* Volleyball Background */
        .volleyball-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .volleyball {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 35% 35%, #fff, #ffd4e5);
            border-radius: 50%;
            opacity: 0.2;
            box-shadow: inset 0 -5px 15px rgba(194, 24, 91, 0.2);
        }

        .volleyball::before,
        .volleyball::after {
            content: '';
            position: absolute;
            background: var(--primary-quynh);
            opacity: 0.4;
        }

        .volleyball::before {
            width: 3px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .volleyball::after {
            width: 100%;
            height: 3px;
            top: 50%;
            transform: translateY(-50%);
        }

        @keyframes float-volleyball {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(20px, -30px) rotate(90deg); }
            50% { transform: translate(-10px, -50px) rotate(180deg); }
            75% { transform: translate(-30px, -20px) rotate(270deg); }
        }

        .volleyball:nth-child(1) { left: 5%; top: 15%; animation: float-volleyball 20s infinite ease-in-out; }
        .volleyball:nth-child(2) { left: 85%; top: 70%; animation: float-volleyball 25s infinite ease-in-out 3s; }
        .volleyball:nth-child(3) { left: 70%; top: 20%; animation: float-volleyball 22s infinite ease-in-out 6s; }
        .volleyball:nth-child(4) { left: 15%; top: 80%; animation: float-volleyball 28s infinite ease-in-out 9s; }

        #app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 16px 20px;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: var(--safe-area-top);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid var(--border-light);
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: 2px solid var(--primary-quynh);
            border-radius: 12px;
            color: var(--primary-quynh);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--primary-quynh);
            color: white;
            transform: translateX(-3px);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-quynh);
        }

        .icon-button:hover {
            background: var(--primary-quynh);
            color: white;
            transform: scale(1.1);
        }

        .calendar-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .calendar-header {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--border-light);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-quynh);
        }

        .nav-button:hover {
            background: var(--primary-quynh);
            color: white;
            transform: scale(1.1);
        }

        .month-year-header {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary-quynh);
            text-align: center;
            min-width: 200px;
        }

        .today-button {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--primary-quynh), var(--primary-light));
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .today-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .view-toggle-nav {
            display: flex;
            background: var(--bg-light);
            border-radius: 16px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 10px 20px;
            border-radius: 12px;
            background: transparent;
            border: none;
            font-weight: 700;
            color: var(--text-medium);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-toggle-btn.active {
            background: white;
            color: var(--primary-quynh);
            box-shadow: var(--shadow-sm);
        }

        /* Schedule Wrapper - FIX */
        .schedule-wrapper {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 3px solid var(--border-light);
            display: flex;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            position: relative;
        }

        .schedule-wrapper::-webkit-scrollbar {
            width: 10px;
        }

        .schedule-wrapper::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        .schedule-wrapper::-webkit-scrollbar-thumb {
            background: var(--primary-quynh);
            border-radius: 5px;
        }

        /* Time Axis - FIX */
        .time-axis {
            flex-shrink: 0;
            width: 70px;
            background: var(--bg-light);
            border-right: 3px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }

        .time-label-line {
            height: var(--hour-height);
            flex-shrink: 0;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-medium);
        }

        .week-view-grid {
            flex-grow: 1;
            display: grid;
            position: relative;
        }

        .day-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 8px;
            background: var(--bg-light);
            border-bottom: 3px solid var(--border-light);
            border-right: 2px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .day-header:last-child {
            border-right: none;
        }

        .day-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .date-label {
            font-size: 1.8rem;
            font-weight: 800;
            width: 50px;
            height: 50px;
            line-height: 50px;
            border-radius: 50%;
            transition: all 0.3s ease;
            color: var(--text-dark);
        }

        .date-label.today {
            background: linear-gradient(135deg, var(--primary-quynh), var(--primary-light));
            color: white;
            box-shadow: 0 4px 16px rgba(194, 24, 91, 0.4);
            animation: pulse-today 2s infinite;
        }

        @keyframes pulse-today {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .day-column {
            border-right: 2px solid var(--border-light);
            position: relative;
            height: calc(var(--hour-height) * 18);
            background: linear-gradient(to bottom, 
                transparent calc(var(--hour-height) - 1px), 
                var(--border-light) calc(var(--hour-height) - 1px), 
                var(--border-light) var(--hour-height), 
                transparent var(--hour-height)
            );
            background-size: 100% var(--hour-height);
            cursor: crosshair;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-column:hover {
            background-color: rgba(194, 24, 91, 0.02);
        }

        /* Event Box - FIX */
        .event-box {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 12px;
            padding: 10px;
            overflow: hidden;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .event-box:hover {
            transform: translateX(3px) scale(1.02);
            box-shadow: 0 8px 24px rgba(194, 24, 91, 0.2);
            z-index: 15;
        }

        .event-box.category-study {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left-color: #1976d2;
        }

        .event-box.category-personal {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
            border-left-color: #c2185b;
        }

        .event-box.category-work {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left-color: #f57c00;
        }

        .event-subject {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 6px;
            color: inherit;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.75rem;
            opacity: 0.85;
        }

        .event-info-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .event-info-row svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: calc(32px + var(--safe-area-bottom));
            right: 32px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-quynh), var(--primary-light));
            color: white;
            font-size: 2.5rem;
            border: 4px solid white;
            box-shadow: 0 8px 32px rgba(194, 24, 91, 0.4);
            z-index: 200;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 48px rgba(194, 24, 91, 0.6);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--border-light);
            transform: scale(0.9);
            animation: scaleIn 0.3s ease forwards;
        }

        @keyframes scaleIn {
            to { transform: scale(1); }
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary-quynh);
            border-radius: 4px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-quynh);
            margin-bottom: 24px;
            text-align: center;
        }

        .modal-toggle {
            display: flex;
            background: var(--bg-light);
            border-radius: 16px;
            padding: 6px;
            gap: 6px;
            margin-bottom: 24px;
        }

        .modal-toggle-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 12px;
            background: transparent;
            border: none;
            font-weight: 700;
            color: var(--text-medium);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-toggle-btn.active {
            background: white;
            color: var(--primary-quynh);
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-medium);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-quynh);
            box-shadow: 0 0 0 4px rgba(194, 24, 91, 0.1);
        }

        .form-group-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .category-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .category-btn {
            padding: 12px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-weight: 600;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .category-btn:hover {
            border-color: var(--primary-quynh);
            background: rgba(194, 24, 91, 0.05);
        }

        .category-btn.active {
            border-color: var(--primary-quynh);
            background: rgba(194, 24, 91, 0.1);
            color: var(--primary-quynh);
        }

        .weekdays-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .weekday-btn {
            flex: 1;
            min-width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--border-light);
            background: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .weekday-btn:hover {
            border-color: var(--primary-quynh);
            background: rgba(194, 24, 91, 0.05);
        }

        .weekday-btn.active {
            background: var(--primary-quynh);
            border-color: var(--primary-quynh);
            color: white;
            transform: scale(1.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .button {
            flex: 1;
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button--primary {
            background: linear-gradient(135deg, var(--primary-quynh), var(--primary-light));
            color: white;
        }

        .button--primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .button--secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .button--danger {
            background: #ff3b30;
            color: white;
        }

        /* Heart Animation - FIX */
        .floating-heart {
            position: fixed;
            font-size: 24px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            animation: floatHeart 1.5s ease-out forwards;
            text-shadow: 0 2px 8px rgba(194, 24, 91, 0.3);
        }

        @keyframes floatHeart {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: translate(var(--drift, 0), -40px) scale(1) rotate(10deg);
            }
            100% {
                opacity: 0;
                transform: translate(calc(var(--drift, 0) * 1.5), -80px) scale(1.2) rotate(15deg);
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: calc(20px + var(--safe-area-top));
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            animation: slideInFromRight 0.3s ease;
        }

        .notification--success { background: #4caf50; }
        .notification--error { background: #f44336; }
        .notification--info { background: #2196f3; }

        @keyframes slideInFromRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            :root {
                --hour-height: 100px;
            }

            .calendar-header {
                padding: 16px;
            }

            .calendar-nav {
                flex-direction: column;
            }

            .view-toggle-nav {
                display: none;
            }

            .week-view-grid {
                grid-template-columns: 1fr !important;
            }

            .modal-content {
                padding: 24px;
            }

            .form-group-inline {
                grid-template-columns: 1fr;
            }

            .category-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="volleyball-bg">
        <div class="volleyball"></div>
        <div class="volleyball"></div>
        <div class="volleyball"></div>
        <div class="volleyball"></div>
    </div>

    <div id="app-container">
        <header class="app-header">
            <button class="back-button" onclick="window.history.back()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                <span>Quay l·∫°i</span>
            </button>

            <div class="header-actions">
                <button class="icon-button" title="T√¨m ki·∫øm">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>
        </header>

        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <div class="nav-controls">
                        <button class="nav-button" id="prev-nav-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <h2 class="month-year-header" id="month-year-header">Th√°ng 10 2025</h2>
                        <button class="nav-button" id="next-nav-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
                            </svg>
                        </button>
                    </div>
                    <button class="today-button" id="today-btn">H√¥m nay</button>
                </div>

                <nav class="view-toggle-nav">
                    <button class="view-toggle-btn" id="view-day-btn">Ng√†y</button>
                    <button class="view-toggle-btn active" id="view-week-btn">Tu·∫ßn</button>
                    <button class="view-toggle-btn" id="view-month-btn">Th√°ng</button>
                </nav>
            </div>

            <div class="schedule-wrapper" id="schedule-wrapper">
                <div class="time-axis" id="time-axis"></div>
                <div class="week-view-grid" id="week-view-grid"></div>
            </div>
        </div>

        <button class="fab" id="add-event-fab">+</button>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="modal-title" id="modal-title">T·∫°o S·ª± Ki·ªán M·ªõi</h2>
            
            <div class="modal-toggle">
                <button type="button" class="modal-toggle-btn active" id="event-mode-btn">üìÖ S·ª± ki·ªán</button>
                <button type="button" class="modal-toggle-btn" id="schedule-mode-btn">üìö L·ªãch h·ªçc</button>
            </div>

            <form id="event-form">
                <div class="form-group">
                    <label>Ti√™u ƒë·ªÅ <span style="color: red;">*</span></label>
                    <input type="text" id="event-title" required placeholder="VD: H·ªçp nh√≥m d·ª± √°n">
                </div>

                <div class="form-group">
                    <label>Danh m·ª•c</label>
                    <div class="category-selector">
                        <button type="button" class="category-btn active" data-category="personal">
                            <span style="font-size: 1.5rem;">üìå</span>
                            <span>C√° nh√¢n</span>
                        </button>
                        <button type="button" class="category-btn" data-category="study">
                            <span style="font-size: 1.5rem;">üìö</span>
                            <span>H·ªçc t·∫≠p</span>
                        </button>
                        <button type="button" class="category-btn" data-category="work">
                            <span style="font-size: 1.5rem;">üíº</span>
                            <span>C√¥ng vi·ªác</span>
                        </button>
                    </div>
                </div>

                <!-- Single Event Fields -->
                <div id="single-event-fields">
                    <div class="form-group">
                        <label>Ng√†y <span style="color: red;">*</span></label>
                        <input type="date" id="single-date" required>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label>B·∫Øt ƒë·∫ßu <span style="color: red;">*</span></label>
                            <input type="time" id="start-time" required min="05:00" max="23:00">
                        </div>
                        <div class="form-group">
                            <label>K·∫øt th√∫c <span style="color: red;">*</span></label>
                            <input type="time" id="end-time" required min="05:00" max="23:00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ƒê·ªãa ƒëi·ªÉm</label>
                        <input type="text" id="event-location" placeholder="VD: P301 - FPT Polytechnic">
                    </div>

                    <div class="form-group">
                        <label>M√¥ t·∫£</label>
                        <textarea id="event-description" rows="3" placeholder="Th√™m chi ti·∫øt..."></textarea>
                    </div>
                </div>

                <!-- Recurring Schedule Fields -->
                <div id="recurring-fields" class="hidden">
                    <div class="form-group-inline">
                        <div class="form-group">
                            <label>Ph√≤ng h·ªçc</label>
                            <input type="text" id="event-classroom" placeholder="VD: P301">
                        </div>
                        <div class="form-group">
                            <label>C∆° s·ªü</label>
                            <input type="text" id="event-campus" placeholder="VD: FPT Polytechnic">
                        </div>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label>B·∫Øt ƒë·∫ßu <span style="color: red;">*</span></label>
                            <input type="time" id="recurring-start-time" required min="05:00" max="23:00">
                        </div>
                        <div class="form-group">
                            <label>K·∫øt th√∫c <span style="color: red;">*</span></label>
                            <input type="time" id="recurring-end-time" required min="05:00" max="23:00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ch·ªçn th·ª© <span style="color: red;">*</span></label>
                        <div class="weekdays-selector">
                            <button type="button" class="weekday-btn" data-day="1">T2</button>
                            <button type="button" class="weekday-btn" data-day="2">T3</button>
                            <button type="button" class="weekday-btn" data-day="3">T4</button>
                            <button type="button" class="weekday-btn" data-day="4">T5</button>
                            <button type="button" class="weekday-btn" data-day="5">T6</button>
                            <button type="button" class="weekday-btn" data-day="6">T7</button>
                            <button type="button" class="weekday-btn" data-day="0">CN</button>
                        </div>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label>T·ª´ ng√†y <span style="color: red;">*</span></label>
                            <input type="date" id="start-date" required>
                        </div>
                        <div class="form-group">
                            <label>ƒê·∫øn ng√†y <span style="color: red;">*</span></label>
                            <input type="date" id="end-date" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="recurring-description" rows="3" placeholder="Ghi ch√∫..."></textarea>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="button button--danger hidden" id="delete-btn">X√≥a</button>
                    <button type="button" class="button button--secondary" id="cancel-btn">H·ªßy</button>
                    <button type="submit" class="button button--primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, get, push, update, remove } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDh0ySHo7sOpgOQ4Ygi1fchXj0LnY6fE2o",
            authDomain: "unisched-app-11368.firebaseapp.com",
            databaseURL: "https://unisched-app-11368-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "unisched-app-11368",
            storageBucket: "unisched-app-11368.firebasestorage.app",
            messagingSenderId: "407354626561",
            appId: "1:407354626561:web:f3624719bb9ae185a4a600"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Firebase Helper Functions
        async function getUserEvents(userId) {
            const eventsRef = ref(db, `users/${userId}/events`);
            try {
                const snapshot = await get(eventsRef);
                return snapshot.exists() ? snapshot.val() : {};
            } catch (error) {
                console.error("L·ªói load events:", error);
                return {};
            }
        }

        function addEvent(userId, eventData) {
            const eventsRef = ref(db, `users/${userId}/events`);
            return push(eventsRef, eventData);
        }

        function updateEvent(userId, eventId, eventData) {
            const eventRef = ref(db, `users/${userId}/events/${eventId}`);
            return update(eventRef, eventData);
        }

        function deleteEvent(userId, eventId) {
            const eventRef = ref(db, `users/${userId}/events/${eventId}`);
            return remove(eventRef);
        }

        // Configuration
        const DAY_START_HOUR = 5;
        const DAY_END_HOUR = 23;
        const HOUR_HEIGHT = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hour-height')) || 80;

        // State
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || 'quynh';
        let currentDate = new Date();
        let currentView = window.innerWidth <= 768 ? 'day' : 'week';
        let userEvents = {};
        let editingEventId = null;
        let currentModalMode = 'event';
        let selectedCategory = 'personal';

        // DOM Elements
        const monthYearHeader = document.getElementById('month-year-header');
        const weekGrid = document.getElementById('week-view-grid');
        const timeAxis = document.getElementById('time-axis');
        const scheduleWrapper = document.getElementById('schedule-wrapper');
        const prevNavBtn = document.getElementById('prev-nav-btn');
        const nextNavBtn = document.getElementById('next-nav-btn');
        const todayBtn = document.getElementById('today-btn');
        const addEventFab = document.getElementById('add-event-fab');
        const eventModal = document.getElementById('event-modal');
        const eventForm = document.getElementById('event-form');
        const deleteBtn = document.getElementById('delete-btn');
        const eventModeBtn = document.getElementById('event-mode-btn');
        const scheduleModeBtn = document.getElementById('schedule-mode-btn');
        const singleEventFields = document.getElementById('single-event-fields');
        const recurringFields = document.getElementById('recurring-fields');
        const categoryButtons = document.querySelectorAll('.category-btn');
        const weekdayButtons = document.querySelectorAll('.weekday-btn');

        // Initialize
        async function init() {
            try {
                userEvents = await getUserEvents(currentUser);
                createTimeAxis();
                updateView();
                attachEventListeners();
                
                if (window.innerWidth <= 768) {
                    setTimeout(scrollToCurrentTime, 500);
                }

                showNotification('Ch√†o m·ª´ng _uyqhn! üèêüíñ', 'success');
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o:', error);
                showNotification('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu! üò¢', 'error');
            }
        }

        // Create Time Axis - FIX
        function createTimeAxis() {
            timeAxis.innerHTML = '';
            
            const headerSpacer = document.createElement('div');
            headerSpacer.style.height = '82px';
            headerSpacer.style.flexShrink = '0';
            timeAxis.appendChild(headerSpacer);
            
            for (let hour = DAY_START_HOUR; hour < DAY_END_HOUR; hour++) {
                const hourString = hour.toString().padStart(2, '0') + ':00';
                const div = document.createElement('div');
                div.className = 'time-label-line';
                div.textContent = hourString;
                timeAxis.appendChild(div);
            }
        }

        // Modal Mode Management
        function setModalMode(mode) {
    currentModalMode = mode;
    const modalTitle = document.getElementById('modal-title');

    // M·ªöI: L·∫•y t·∫•t c·∫£ c√°c tr∆∞·ªùng input/textarea c·ªßa c·∫£ hai ch·∫ø ƒë·ªô
    const singleInputs = singleEventFields.querySelectorAll('input, textarea');
    const recurringInputs = recurringFields.querySelectorAll('input, textarea');
    
    if (mode === 'event') {
        modalTitle.textContent = editingEventId ? 'Ch·ªânh s·ª≠a S·ª± ki·ªán' : 'T·∫°o S·ª± Ki·ªán M·ªõi';
        document.getElementById('event-title').placeholder = "VD: H·ªçp nh√≥m d·ª± √°n";
        eventModeBtn.classList.add('active');
        scheduleModeBtn.classList.remove('active');
        
        // Hi·ªÉn th·ªã "S·ª± ki·ªán", ·∫©n "L·ªãch h·ªçc"
        singleEventFields.classList.remove('hidden');
        recurringFields.classList.add('hidden');
        
        // M·ªöI: K√≠ch ho·∫°t (enable) c√°c tr∆∞·ªùng "S·ª± ki·ªán"
        singleInputs.forEach(input => input.disabled = false);
        
        // M·ªöI: V√¥ hi·ªáu h√≥a (disable) c√°c tr∆∞·ªùng "L·ªãch h·ªçc"
        recurringInputs.forEach(input => input.disabled = true);

    } else { // mode === 'schedule'
        modalTitle.textContent = editingEventId ? 'Ch·ªânh s·ª≠a L·ªãch H·ªçc' : 'T·∫°o L·ªãch H·ªçc M·ªõi';
        document.getElementById('event-title').placeholder = "VD: Ph√°t tri·ªÉn ·ª©ng d·ª•ng Web";
        scheduleModeBtn.classList.add('active');
        eventModeBtn.classList.remove('active');
        
        // Hi·ªÉn th·ªã "L·ªãch h·ªçc", ·∫©n "S·ª± ki·ªán"
        recurringFields.classList.remove('hidden');
        singleEventFields.classList.add('hidden');
        
        // M·ªöI: V√¥ hi·ªáu h√≥a (disable) c√°c tr∆∞·ªùng "S·ª± ki·ªán" (ƒê√¢y l√† m·∫•u ch·ªët ƒë·ªÉ fix l·ªói)
        singleInputs.forEach(input => input.disabled = true);
        
        // M·ªöI: K√≠ch ho·∫°t (enable) c√°c tr∆∞·ªùng "L·ªãch h·ªçc"
        recurringInputs.forEach(input => input.disabled = false);
    }
}

        // Get week days
        function getWeekDays(date) {
            const startOfWeek = new Date(date);
            const dayOfWeek = startOfWeek.getDay();
            startOfWeek.setDate(date.getDate() - dayOfWeek);
            
            const week = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                week.push(day);
            }
            return week;
        }

        // Update View
        function updateView() {
            renderWeekView(currentDate);
            updateHeader();
        }

        // Update Header
        function updateHeader() {
            const weekDays = getWeekDays(currentDate);
            const firstDay = weekDays[0];
            const lastDay = weekDays[6];
            
            if (firstDay.getMonth() !== lastDay.getMonth()) {
                monthYearHeader.textContent = `Thg ${firstDay.getMonth() + 1} - Thg ${lastDay.getMonth() + 1}, ${lastDay.getFullYear()}`;
            } else {
                monthYearHeader.textContent = `Th√°ng ${firstDay.getMonth() + 1}, ${firstDay.getFullYear()}`;
            }
        }

        // Render Week View
        function renderWeekView(dateInWeek) {
            const weekDays = getWeekDays(dateInWeek);
            weekGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
            weekGrid.innerHTML = '';
            
            const today = new Date();
            const dayLabels = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            
            weekDays.forEach(day => {
                const isToday = day.toDateString() === today.toDateString();
                weekGrid.innerHTML += `
                    <div class="day-header">
                        <div class="day-label">${dayLabels[day.getDay()]}</div>
                        <div class="date-label ${isToday ? 'today' : ''}">${day.getDate()}</div>
                    </div>
                `;
            });
            
            weekDays.forEach(day => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                dayColumn.dataset.date = day.toISOString().split('T')[0];
                weekGrid.appendChild(dayColumn);
                renderEventsForDay(dayColumn, day);
            });

            attachHoverHearts();
        }

        // Render Events for Day - FIX
        function renderEventsForDay(dayColumn, date) {
            const dateString = date.toISOString().split('T')[0];
            
            Object.entries(userEvents).forEach(([eventId, event]) => {
                if (event.type === 'single' && event.date === dateString) {
                    const eventEl = createEventElement(event, eventId);
                    if (eventEl) dayColumn.appendChild(eventEl);
                }
                
                if (event.type === 'recurring' && event.daysOfWeek) {
                    const startDate = event.startDate ? new Date(event.startDate) : null;
                    const endDate = event.endDate ? new Date(event.endDate) : null;
                    const inRange = (!startDate || date >= startDate) && (!endDate || date <= endDate);
                    
                    if (inRange && event.daysOfWeek.includes(date.getDay())) {
                        const eventEl = createEventElement(event, eventId);
                        if (eventEl) dayColumn.appendChild(eventEl);
                    }
                }
            });
        }

        // Create Event Element - FIX
        function createEventElement(event, eventId) {
            const startHour = parseInt(event.startTime.split(':')[0]);
            const startMinute = parseInt(event.startTime.split(':')[1]);
            const endHour = parseInt(event.endTime.split(':')[0]);
            const endMinute = parseInt(event.endTime.split(':')[1]);

            const startMinutes = startHour * 60 + startMinute;
            const endMinutes = endHour * 60 + endMinute;
            const dayStartMinutes = DAY_START_HOUR * 60;
            const dayEndMinutes = DAY_END_HOUR * 60;

            const visibleStart = Math.max(startMinutes, dayStartMinutes);
            const visibleEnd = Math.min(endMinutes, dayEndMinutes);
            const duration = visibleEnd - visibleStart;

            if (duration <= 0) return null;

            const pxPerMinute = HOUR_HEIGHT / 60;
            const top = (visibleStart - dayStartMinutes) * pxPerMinute;
            const height = Math.max(duration * pxPerMinute, 50);

            const eventEl = document.createElement('div');
            eventEl.className = `event-box category-${event.category || 'personal'}`;
            eventEl.dataset.eventId = eventId;
            eventEl.style.top = `${top}px`;
            eventEl.style.height = `${height}px`;

            const title = event.subjectName || event.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
            const timeStr = `${event.startTime} - ${event.endTime}`;
            const location = event.classroom || event.campus || '';
            
            eventEl.innerHTML = `
                <div class="event-subject">${title}</div>
                <div class="event-info">
                    <div class="event-info-row">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span>${timeStr}</span>
                    </div>
                    ${location ? `
                    <div class="event-info-row">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>${location}</span>
                    </div>
                    ` : ''}
                </div>
            `;

            eventEl.addEventListener('click', () => openModal(eventId));

            return eventEl;
        }

        // Open Modal
        function openModal(eventId = null) {
            editingEventId = eventId;
            
            if (eventId && userEvents[eventId]) {
                const event = userEvents[eventId];
                setModalMode(event.type === 'single' ? 'event' : 'schedule');
                populateForm(event);
                deleteBtn.classList.remove('hidden');
            } else {
                setModalMode('event');
                eventForm.reset();
                setDefaultDates();
                deleteBtn.classList.add('hidden');
            }
            
            eventModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Populate Form
        function populateForm(event) {
            document.getElementById('event-title').value = event.title || event.subjectName || '';
            
            selectedCategory = event.category || 'personal';
            categoryButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === selectedCategory);
            });
            
            if (event.type === 'single') {
                document.getElementById('single-date').value = event.date || '';
                document.getElementById('start-time').value = event.startTime || '';
                document.getElementById('end-time').value = event.endTime || '';
                document.getElementById('event-location').value = event.classroom || '';
                document.getElementById('event-description').value = event.description || '';
            } else {
                document.getElementById('event-classroom').value = event.classroom || '';
                document.getElementById('event-campus').value = event.campus || '';
                document.getElementById('recurring-start-time').value = event.startTime || '';
                document.getElementById('recurring-end-time').value = event.endTime || '';
                document.getElementById('start-date').value = event.startDate || '';
                document.getElementById('end-date').value = event.endDate || '';
                document.getElementById('recurring-description').value = event.description || '';
                
                if (event.daysOfWeek) {
                    weekdayButtons.forEach(btn => {
                        const day = parseInt(btn.dataset.day);
                        btn.classList.toggle('active', event.daysOfWeek.includes(day));
                    });
                }
            }
        }

        // Set Default Dates
        function setDefaultDates() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('single-date').value = dateString;
            document.getElementById('start-date').value = dateString;
            
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('end-date').value = nextMonth.toISOString().split('T')[0];
        }

        // Close Modal
        function closeModal() {
            eventModal.classList.add('hidden');
            document.body.style.overflow = '';
            eventForm.reset();
            editingEventId = null;
            weekdayButtons.forEach(btn => btn.classList.remove('active'));
        }

        // Form Submit - FIX
        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('event-title').value;
            let eventData = {};
            
            if (currentModalMode === 'event') {
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                
                if (startTime >= endTime) {
                    showNotification('Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu!', 'error');
                    return;
                }
                
                eventData = {
                    type: 'single',
                    title: title,
                    date: document.getElementById('single-date').value,
                    startTime: startTime,
                    endTime: endTime,
                    category: selectedCategory,
                    classroom: document.getElementById('event-location').value,
                    description: document.getElementById('event-description').value
                };
            } else {
                const selectedDays = Array.from(weekdayButtons)
                    .filter(btn => btn.classList.contains('active'))
                    .map(btn => parseInt(btn.dataset.day));
                
                if (selectedDays.length === 0) {
                    showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ng√†y trong tu·∫ßn!', 'error');
                    return;
                }
                
                const startTime = document.getElementById('recurring-start-time').value;
                const endTime = document.getElementById('recurring-end-time').value;
                
                if (startTime >= endTime) {
                    showNotification('Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu!', 'error');
                    return;
                }
                
                eventData = {
                    type: 'recurring',
                    subjectName: title,
                    classroom: document.getElementById('event-classroom').value,
                    campus: document.getElementById('event-campus').value,
                    startTime: startTime,
                    endTime: endTime,
                    startDate: document.getElementById('start-date').value,
                    endDate: document.getElementById('end-date').value,
                    daysOfWeek: selectedDays,
                    category: selectedCategory,
                    description: document.getElementById('recurring-description').value
                };
            }
            
            try {
                if (editingEventId) {
                    await updateEvent(currentUser, editingEventId, eventData);
                    userEvents[editingEventId] = eventData;
                    showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng! ‚ú®', 'success');
                } else {
                    const newEventRef = await addEvent(currentUser, eventData);
                    userEvents[newEventRef.key] = eventData;
                    showNotification('Th√™m th√†nh c√¥ng! üéâ', 'success');
                }
                
                closeModal();
                updateView();
            } catch (error) {
                console.error('L·ªói l∆∞u:', error);
                showNotification('C√≥ l·ªói x·∫£y ra! üò¢', 'error');
            }
        });

        // Delete Event - FIX
        deleteBtn.addEventListener('click', async () => {
            if (!editingEventId) return;
            
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?')) {
                try {
                    await deleteEvent(currentUser, editingEventId);
                    delete userEvents[editingEventId];
                    closeModal();
                    updateView();
                    showNotification('ƒê√£ x√≥a! üóëÔ∏è', 'success');
                } catch (error) {
                    console.error('L·ªói x√≥a:', error);
                    showNotification('Kh√¥ng th·ªÉ x√≥a! üò¢', 'error');
                }
            }
        });

        // Attach Event Listeners
        function attachEventListeners() {
            prevNavBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 7);
                updateView();
            });

            nextNavBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 7);
                updateView();
            });

            todayBtn.addEventListener('click', () => {
                currentDate = new Date();
                updateView();
                if (window.innerWidth <= 768) {
                    setTimeout(scrollToCurrentTime, 300);
                }
            });

            addEventFab.addEventListener('click', () => openModal());
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            
            eventModeBtn.addEventListener('click', () => setModalMode('event'));
            scheduleModeBtn.addEventListener('click', () => setModalMode('schedule'));

            categoryButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    categoryButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedCategory = btn.dataset.category;
                });
            });

            weekdayButtons.forEach(btn => {
                btn.addEventListener('click', () => btn.classList.toggle('active'));
            });

            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) closeModal();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !eventModal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        }

        // Scroll to Current Time
        function scrollToCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            
            if (hours >= DAY_START_HOUR && hours <= DAY_END_HOUR) {
                const scrollPosition = (hours - DAY_START_HOUR - 1) * HOUR_HEIGHT;
                scheduleWrapper.scrollTop = Math.max(0, scrollPosition);
            }
        }

        // Heart Animation - FIX
        function attachHoverHearts() {
            const dayColumns = document.querySelectorAll('.day-column');
            
            dayColumns.forEach(column => {
                let lastHeartTime = 0;
                
                column.addEventListener('mousemove', (e) => {
                    const now = Date.now();
                    if (now - lastHeartTime < 150) return;
                    
                    if (Math.random() > 0.7) {
                        createFloatingHeart(e.clientX, e.clientY);
                        lastHeartTime = now;
                    }
                });
            });
        }

        function createFloatingHeart(x, y) {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.textContent = ['üíñ', 'üíï', 'üíó', 'üíù'][Math.floor(Math.random() * 4)];
            heart.style.left = x + 'px';
            heart.style.top = y + 'px';
            
            const drift = (Math.random() - 0.5) * 40;
            heart.style.setProperty('--drift', drift + 'px');
            
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1500);
        }

        // Notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification--${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInFromRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initialize
        init();
    </script>
</body>
</html>